name: OCR PDFs via Web

on:
  workflow_dispatch:
    inputs:
      pdfs:
        description: 'Liste de PDFs à traiter (séparés par des virgules)'
        required: true
        default: '2.pdf,3.pdf'

jobs:
  ocr:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # 3️⃣ Install dependencies
      - name: Install dependencies
        run: npm install puppeteer fs-extra

      # 4️⃣ Run Puppeteer OCR for each PDF
      - name: Run OCR via headless browser
        run: |
          node <<'EOF'
          import fs from 'fs-extra';
          import path from 'path';
          import puppeteer from 'puppeteer';

          const pdfs = process.env.PDFS.split(',').map(p => p.trim());
          const outputDir = process.cwd();
          const baseUrl = 'https://yannkerherve.github.io/secretaires/ocristeur.htm';

          const browser = await puppeteer.launch({
            headless: true,
            args: ['--no-sandbox', '--disable-setuid-sandbox']
          });
          const page = await browser.newPage();

          for (const pdfFile of pdfs){
            const pdfUrl = `${baseUrl}?pdf=${encodeURIComponent(pdfFile)}`;
            console.log(`➡️  Traitement: ${pdfFile}`);
            await page.goto(pdfUrl, {waitUntil: 'networkidle2'});

            // Attendre que le bouton CSV soit actif - max 10 heures !
            await page.waitForSelector('#downloadCsvBtn:not([disabled])', { timeout: 36000000 };

            // Attendre que la page indique que le CSV est prêt
            await page.waitForFunction(
              () => document.getElementById('status').textContent.includes('CSV prêt à télécharger !'),
              { timeout: 60000 }
            );

            // Récupérer le CSV exposé dans window.downloadCsvBlob
            const csvContent = await page.evaluate(() => {
              return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsText(window.downloadCsvBlob);
              });
            });

            // Sauvegarder le CSV avec le nom du PDF
            const outPath = path.join(outputDir, pdfFile.replace(/\.pdf$/i,'.csv'));
            fs.writeFileSync(outPath, csvContent, 'utf-8');
            console.log(`✅ CSV enregistré: ${outPath}`);
          }

          await browser.close();
          EOF
        env:
          PDFS: ${{ github.event.inputs.pdfs }}

      # 5️⃣ Upload CSVs as artifact
      - name: Upload CSVs
        uses: actions/upload-artifact@v4
        with:
          name: ocr-csvs
          path: "*.csv"
